
<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Web TÃ i Xá»‰u LamcubÃ©</title>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>ğŸ² Web TÃ i Xá»‰u Realtime</h1>

<div id="auth">
    <h3>ÄÄƒng kÃ½</h3>
    <input id="reg_user" placeholder="Username">
    <input id="reg_pass" type="password" placeholder="Password">
    <button onclick="register()">ÄÄƒng kÃ½</button>

    <h3>ÄÄƒng nháº­p</h3>
    <input id="login_user" placeholder="Username">
    <input id="login_pass" type="password" placeholder="Password">
    <button onclick="login()">ÄÄƒng nháº­p</button>
</div>

<div id="game" style="display:none;">
    <div>Tiá»n: <span id="money"></span> xu</div>
    <div>Thá»i gian Ä‘áº·t cÆ°á»£c: <span id="timer">30</span> giÃ¢y</div>

    <h3>Chá»n má»©c cÆ°á»£c:</h3>
    <select id="bet_amount">
        <option value="5000">5k</option>
        <option value="10000">10k</option>
        <option value="50000">50k</option>
        <option value="100000">100k</option>
        <option value="500000">500k</option>
    </select>

    <button id="bet_tai" onclick="placeBet('TÃ i')">Äáº·t TÃ i</button>
    <button id="bet_xiu" onclick="placeBet('Xá»‰u')">Äáº·t Xá»‰u</button>
    <label><input type="checkbox" id="auto_bet"> Auto má»Ÿ bÃ¡t</label>

    <h3>Káº¿t quáº£:</h3>
    <div id="dice_area"></div>
    <div id="outcome"></div>

    <h3>Lá»‹ch sá»­ 10 vÃ²ng gáº§n nháº¥t:</h3>
    <div id="history_box" style="border:1px solid white; padding:5px; height:150px; overflow:auto;"></div>

    <h3>Top ngÆ°á»i tháº¯ng tiá»n gáº§n nháº¥t:</h3>
    <div id="top_win_box" style="border:1px solid white; padding:5px; height:150px; overflow:auto;"></div>

    <h3>Chat realtime:</h3>
    <div id="chat_box" style="border:1px solid white; height:150px; overflow:auto;"></div>
    <input id="chat_input" placeholder="Nháº­p tin nháº¯n">
    <button onclick="sendChat()">Gá»­i</button>

    <audio id="bg_music" loop>
        <source src="music.mp3" type="audio/mpeg">
        TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ audio.
    </audio>
    <label>
        <input type="checkbox" id="toggle_music" checked> Nháº¡c ná»n
    </label>
</div>

<script>
const socket = io();
let username = "";

function register(){
    fetch("/register",{
        method:"POST",
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username: document.getElementById("reg_user").value,
                               password: document.getElementById("reg_pass").value })
    }).then(r=>r.json()).then(r=>alert(r.msg));
}

function login(){
    fetch("/login",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ username:document.getElementById("login_user").value,
                              password:document.getElementById("login_pass").value })
    }).then(r=>r.json()).then(r=>{
        if(r.success){
            username = document.getElementById("login_user").value;
            document.getElementById("auth").style.display="none";
            document.getElementById("game").style.display="block";
            document.getElementById("money").innerText = r.money;
            socket.emit("player_login",{username});

            // Auto play nháº¡c (náº¿u Ä‘Æ°á»£c trÃ¬nh duyá»‡t cho phÃ©p)
            const bgMusic = document.getElementById("bg_music");
            const toggleMusic = document.getElementById("toggle_music");
            if(toggleMusic.checked) bgMusic.play().catch(()=>console.log("Chá» tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng Ä‘á»ƒ phÃ¡t nháº¡c"));
            toggleMusic.addEventListener("change", ()=>{
                if(toggleMusic.checked) bgMusic.play().catch(()=>console.log("Chá» tÆ°Æ¡ng tÃ¡c"));
                else bgMusic.pause();
            });
        } else alert(r.msg);
    });
}

function placeBet(type){
    let amount = parseInt(document.getElementById("bet_amount").value);
    let auto = document.getElementById("auto_bet").checked;
    socket.emit("bet",{type, amount, auto});
}

socket.on("update_player", player => {
    document.getElementById("money").innerText = player.money;
});

socket.on("bet_update", data=>{
    console.log("CÆ°á»£c hiá»‡n táº¡i:", data);
});

socket.on("bet_locked", ()=>{
    document.getElementById("bet_tai").disabled = true;
    document.getElementById("bet_xiu").disabled = true;
});

socket.on("bet_error", msg=>{
    alert(msg);
});

const diceEmoji = ["","âš€","âš","âš‚","âšƒ","âš„","âš…"];

socket.on("round_result", data=>{
    document.getElementById("bet_tai").disabled = false;
    document.getElementById("bet_xiu").disabled = false;

    const dice_area = document.getElementById("dice_area");
    const outcome = document.getElementById("outcome");
    dice_area.innerHTML = "";
    let i=0;
    function showNext(){
        if(i>=data.result.length){
            outcome.innerText = `Káº¿t quáº£: ${data.outcome}`;
            if(data.players[socket.id]) document.getElementById("money").innerText = data.players[socket.id].money;
            return;
        }
        let span = document.createElement("span");
        span.style.fontSize = "50px";
        span.style.margin = "5px";
        span.innerText = diceEmoji[data.result[i]];
        dice_area.appendChild(span);
        i++;
        setTimeout(showNext, 1000);
    }
    showNext();
});

// Timer
socket.on("timer_update", (time, inBreak)=>{
    const timerEl = document.getElementById("timer");
    timerEl.innerText = time + " giÃ¢y";
    if(inBreak){
        timerEl.innerText += " (Äang nghá»‰ giá»¯a vÃ²ng)";
        document.getElementById("bet_tai").disabled = true;
        document.getElementById("bet_xiu").disabled = true;
    } else {
        document.getElementById("bet_tai").disabled = false;
        document.getElementById("bet_xiu").disabled = false;
    }
});

socket.on("new_round", ()=>{
    alert("VÃ²ng má»›i báº¯t Ä‘áº§u! Chuáº©n bá»‹ Ä‘áº·t cÆ°á»£c!");
});

// Chat
function sendChat(){
    let msg = document.getElementById("chat_input").value;
    if(msg.trim() === "") return;
    socket.emit("chat",msg);
    document.getElementById("chat_input").value="";
}

socket.on("chat_history", history=>{
    const box = document.getElementById("chat_box");
    box.innerHTML = history.map(c=>`<b>${c.username}:</b> ${c.msg}`).join("<br>");
    box.scrollTop = box.scrollHeight;
});

// Lá»‹ch sá»­ vÃ²ng
socket.on("round_history", history=>{
    const box = document.getElementById("history_box");
    box.innerHTML = history.map((r,i)=>{
        const diceStr = r.result.map(d=>diceEmoji[d]).join(" ");
        return `<b>VÃ²ng ${i+1}:</b> ${diceStr} â†’ ${r.outcome}`;
    }).join("<br>");
    box.scrollTop = box.scrollHeight;
});

// Top win
socket.on("top_wins", data=>{
    const box = document.getElementById("top_win_box");
    if(data.length === 0){
        box.innerHTML = "ChÆ°a cÃ³ ngÆ°á»i tháº¯ng vÃ²ng nÃ o";
        return;
    }
    box.innerHTML = data.map((r,i)=>{
        return `<b>${i+1}. ${r.username}</b> +${r.win} xu`;
    }).join("<br>");
    box.scrollTop = box.scrollHeight;
});
</script>
</body>
</html>